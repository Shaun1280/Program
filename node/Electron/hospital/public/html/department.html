<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <link rel="stylesheet" href="../materialize/css/materialize.min.css">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="stylesheet" href="../css/style.css">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>科室</title>
</head>
<body>
    <ul id="slide-out" class="side-nav fixed">
        <li class="no-padding">
          <ul class="collapsible collapsible-accordion">
            <li>
              <a class="collapsible-header">导航<i class="material-icons">arrow_drop_down</i></a>
              <div class="collapsible-body">
                <ul>
                    <li><a href="../html/index.html">普通科室候诊</a></li> <!--option1-->
                    <li><a href="../html/ultrasound_index.html">B 超室候诊</a></li>

                  <ul class="collapsible collapsible-accordion"> <!--option2-->
                    <li>
                      <a class="collapsible-header">挂号<i class="material-icons">arrow_drop_down</i></a>
                      <div class="collapsible-body">
                        <ul>
                          <li><a href="../html/addPatient.html">添加就诊人</a></li>
                          <li><a href="../html/randomAddPatient.html">随机添加</a></li>
                        </ul>
                      </div>
                    </li>
                  </ul>

                  <li><a href="../html/department.html">科室</a></li> <!--option3-->
                </ul>
              </div>
            </li>
          </ul>
        </li>
    </ul>
    <a href="#" data-activates="slide-out" class="button-collapse"><i class="material-icons">menu</i></a>

    <main>
        <div id="department-container">
            <div id="department-wrapper">
                <ul class="collapsible popout collap-department" data-collapsible="accordion">
                    <!--department-1-->
                    <li id="department-1">
                        <div class="collapsible-header">
                            <i class="material-icons">queue</i>
                            科室 1
                        </div>
    
                        <div class="collapsible-body"> <!---collapsible body-->
                            <div class="department-container">
                                <!--doctor-1-->
                                <div class="hoverable department-doctor" id="doctor-1">
                                    <div class="left-align doctor-status">
                                        <div class="doctor-status-icon green" title="空闲"></div>
                                        <div>
                                            <i class="material-icons">supervisor_account</i> 
                                            &nbsp Doctor-1 &nbsp
                                        </div>
                                    </div>
                                    
                                    <div class="right-align doctor-btns">
                                        <a class="btn-floating btn-small waves-effect waves-light green" id="next_patient" title="下一位病人"><i class="material-icons">add</i></a>
                                        <a class="btn-floating btn-small waves-effect waves-light yellow" id="to_b_room" title="开具 B 超"><i class="material-icons">mode_edit</i></a>
                                        <a class="btn-floating btn-small waves-effect waves-light blue" id="done" title="诊断结束"><i class="material-icons">done</i></a>
                                        <a class="btn-floating btn-small waves-effect waves-light red" id="patientlist" title="历史就诊信息"><i class="material-icons">insert_chart</i></a>
                                    </div>
                                </div>
        
                                <!--doctor-2-->
                                <div class="hoverable department-doctor" id="doctor-2">
                                    <div class="left-align doctor-status">
                                        <div class="doctor-status-icon green" title="空闲"></div>
                                        <div>
                                            <i class="material-icons">supervisor_account</i> 
                                            &nbsp Doctor-2 &nbsp
                                        </div>
                                    </div>
                                    
                                    <div class="right-align doctor-btns">
                                        <a class="btn-floating btn-small waves-effect waves-light green" id="next_patient" title="下一位病人"><i class="material-icons">add</i></a>
                                        <a class="btn-floating btn-small waves-effect waves-light yellow" id="to_b_room" title="开具 B 超"><i class="material-icons">mode_edit</i></a>
                                        <a class="btn-floating btn-small waves-effect waves-light blue" id="done" title="就诊完成"><i class="material-icons">done</i></a>
                                        <a class="btn-floating btn-small waves-effect waves-light red" id="patientlist" title="历史就诊信息"><i class="material-icons">insert_chart</i></a>
                                    </div>
                                </div>
        
                                <!--doctor-3-->
                                <div class="hoverable department-doctor" id="doctor-3">
                                    <div class="left-align doctor-status">
                                        <div class="doctor-status-icon green" title="空闲"></div>
                                        <div>
                                            <i class="material-icons">supervisor_account</i> 
                                            &nbsp Doctor-3 &nbsp
                                        </div>
                                    </div>
                                    
                                    <div class="right-align doctor-btns">
                                        <a class="btn-floating btn-small waves-effect waves-light green" id="next_patient" title="下一位病人"><i class="material-icons">add</i></a>
                                        <a class="btn-floating btn-small waves-effect waves-light yellow" id="to_b_room" title="开具 B 超"><i class="material-icons">mode_edit</i></a>
                                        <a class="btn-floating btn-small waves-effect waves-light blue" id="done" title="就诊完成"><i class="material-icons">done</i></a>
                                        <a class="btn-floating btn-small waves-effect waves-light red" id="patientlist" title="历史就诊信息"><i class="material-icons">insert_chart</i></a>
                                    </div>
                                </div>
    
                                <!--patient table-->
                                <table class="highlight bordered">
                                    <caption class="centered">科室排队信息</caption>
                                    <thead>
                                        <tr>
                                            <th>就诊号</th>
                                            <th>医生</th>
                                            <th>姓名</th>
                                            <th>状态</th>
                                        </tr>
                                    </thead>
                            
                                    <tbody></tbody>
                                </table>
                            </div>
                            <!-- end of department container-->
                        </div>
                        <!--end of body-->
                    </li>
                    <!--end of department 1-->
                </ul>
            </div>
        </div>
    </main>
    
    <script src="../../node_modules/hammerjs/hammer.js"></script>
    <script type="text/javascript" src="https://code.jquery.com/jquery-2.1.1.min.js"></script>
    <script src="../materialize/js/materialize.min.js"></script>
    <script type="text/javascript">
        let li = document.getElementById("department-1");
        let ul = li.parentElement, wrapper = ul.parentElement;
        for (let i = 0; i < 3; i++) {
            let newli = document.createElement("li");
            newli = li.cloneNode(true);
            ul.appendChild(newli);
        }
        let newul = ul.cloneNode(true);
        wrapper.append(newul);

        let container = document.getElementById("department-container");
        let department_wrapper = document.getElementById("department-wrapper");
        let newDepWrapper = department_wrapper.cloneNode(true);
        container.appendChild(newDepWrapper);

        let curDepartmentId = 1;
        let iconName = ["", "queue", "perm_identity", "contacts", "subtitles", "visibility", "group_work",
        "person_pin", "description", "dashboard", "perm_contact_calendar", "verified_user", "add_alert",
         "note_add", "assignment_ind", "library_books", "report_problem"];
        Array.from(document.querySelector("main").querySelectorAll("li")).forEach(item => {
            item.setAttribute("id", "department-" + curDepartmentId);
            if (curDepartmentId <= 15) {
                item.firstElementChild.innerHTML = `<i class="material-icons">`+ iconName[curDepartmentId] +`</i>科室 ${curDepartmentId}`;
            }
            else {
                item.firstElementChild.innerHTML = `<i class="material-icons">`+ iconName[curDepartmentId] + `</i>B 超室`;
            }
            curDepartmentId++;
        })

        let dep16 = document.querySelector("#department-16")
        for (let i = 1; i <= 3; i++) {
            let doctor = dep16.querySelector("#doctor-" + i);
            doctor.querySelector("#to_b_room").remove();
        }

        Array.from(document.querySelectorAll(".department-doctor")).forEach(item => {
            let tmp = item.querySelector('.doctor-btns');
            item.onmouseover = (e) => {
                tmp.classList.remove('doctor-btns');
            }
            item.onmouseout = (e) => {
                tmp.classList.add('doctor-btns');
            }
        });

        $(".button-collapse").sideNav();
    </script>
    <script type="module">
        const { ipcRenderer } = require('electron');

        window.onload = () => { ipcRenderer.send("department:load"); }

        Array.from(document.querySelectorAll("a")).forEach(item => {
            item.onclick = () => {
                let id = item.getAttribute("id");
                if (id == "next_patient") {
                    let doctorId = item.parentElement.parentElement.getAttribute("id");
                    let departmentId = item.parentElement.parentElement.parentElement.parentElement.parentElement.getAttribute("id");
                    ipcRenderer.send("doctor:next_patient", parseInt(departmentId.split("-")[1]), parseInt(doctorId.split("-")[1]));
                } else if (id == "to_b_room") {
                    let doctorId = item.parentElement.parentElement.getAttribute("id");
                    let departmentId = item.parentElement.parentElement.parentElement.parentElement.parentElement.getAttribute("id");
                    ipcRenderer.send("doctor:ultrasound", parseInt(departmentId.split("-")[1]), parseInt(doctorId.split("-")[1]));
                } else if (id == "done") {
                    let doctorId = item.parentElement.parentElement.getAttribute("id");
                    let departmentId = item.parentElement.parentElement.parentElement.parentElement.parentElement.getAttribute("id");
                    ipcRenderer.send("doctor:done", parseInt(departmentId.split("-")[1]), parseInt(doctorId.split("-")[1]));
                } else if (id == "patientlist") {
                    let doctorId = item.parentElement.parentElement.getAttribute("id");
                    let departmentId = item.parentElement.parentElement.parentElement.parentElement.parentElement.getAttribute("id");
                    ipcRenderer.send("doctor:historyPatientList", parseInt(departmentId.split("-")[1]), parseInt(doctorId.split("-")[1]));
                }
            }
        })

        ipcRenderer.removeAllListeners("doctor:status"); 
        ipcRenderer.on("doctor:status", (e, department, doctor, status) => { // 修改医生状态
            let div = document.querySelector(`#department-${department}`).querySelector(`#doctor-${doctor}`).firstElementChild.firstElementChild;
            if (status == 2) {
                if (div.classList.contains("green")) div.classList.remove("green");
                if (div.classList.contains("yellow")) div.classList.remove("yellow");
                div.classList.add("red");
                div.setAttribute("title", "忙碌")
            } else if (status == 0) {
                if (div.classList.contains("red")) div.classList.remove("red");
                if (div.classList.contains("yellow")) div.classList.remove("yellow");
                div.classList.add("green");
                div.setAttribute("title", "空闲")
            } else if (status == 1) {
                if (div.classList.contains("red")) div.classList.remove("red");
                if (div.classList.contains("green")) div.classList.remove("green");
                div.classList.add("yellow");
                div.setAttribute("title", "病人等候中")
            }
        })

        ipcRenderer.removeAllListeners("department:displayedPatient");
        ipcRenderer.on("department:displayedPatient", (e, department, array) => {
            let tbody = document.querySelector(`#department-${department}`).querySelector("tbody");
            tbody.innerHTML = ``;

            for (let i = 0; i < array.length; i++) {
                let tr = document.createElement("tr");
                let tdId = document.createElement("td");
                tdId.innerHTML = array[i].id;

                let tdDoctor = document.createElement("td");
                if (department != 16) {
                    tdDoctor.innerHTML = array[i].doctorid;
                    if (array[i].doctorid == -1) tdDoctor.innerHTML = "";
                } else {
                    tdDoctor.innerHTML = array[i].bDoctorid;
                    if (array[i].bDoctorid == -1) tdDoctor.innerHTML = "";
                }
                

                let tdName = document.createElement("td");
                tdName.innerHTML = array[i].name;

                let tdStatus = document.createElement("td");
                if (department != 16) {
                    if (array[i].treatmentTime == "") {
                        tdStatus.innerHTML = "候诊", tdStatus.classList.add("red-text");
                    } else if (array[i].bTreatmentTime != "") {
                        tdStatus.innerHTML = "复诊", tdStatus.classList.add("blue-text");
                    } else {
                        tdStatus.innerHTML = "就诊", tdStatus.classList.add("green-text");
                    }
                } else {
                    if (array[i].bTreatmentTime == "") {
                        tdStatus.innerHTML = "待检查", tdStatus.classList.add("red-text");
                    } else {
                        tdStatus.innerHTML = "检查中", tdStatus.classList.add("green-text");
                    }
                }

                tr.append(tdId, tdDoctor, tdName, tdStatus);
                tbody.append(tr);
            }
        })
    </script>

    <script type="module">
    const { remote, ipcRenderer } = require('electron');
    const { FindInPage } = require('electron-find');
    let findInPage = null;

    ipcRenderer.removeAllListeners('page:find');
    ipcRenderer.on('page:find', () => {
      if (findInPage != null) findInPage.closeFindWindow(), findInPage.destroy();
      findInPage = new FindInPage(remote.getCurrentWebContents(), {
          preload: true,
          offsetTop: 0,
          offsetRight: 30
      })
      findInPage.openFindWindow();
    })
  </script>
</body>
</html>